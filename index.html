<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Gran Rifa</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="https://res.cloudinary.com/dqqeavica/image/upload/v1760479569/Rifa_qjma4q.png">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    :root{
      --primary:#0b66ff;
      --primary-2:#0a58d3;
      --ok:#16a34a;
      --error:#dc2626;
    }
    html,body{
      margin:0; padding:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:#111; background:#f6f8ff;
    }
    .container{ max-width: 960px; margin: 0 auto; padding: 16px; }
    .view{ display:none; opacity:0; transform: translateY(8px);
      transition: opacity .25s ease, transform .25s ease; padding:0 16px;
    }
    .view.active{ display:block; opacity:1; transform: translateY(0); }
    .card{
      background:#fff; border:2px solid #e5e7eb; border-radius:14px;
      box-shadow: 0 8px 22px rgba(0,0,0,.06);
      max-width: 820px; margin: 16px auto; padding: 16px 16px 18px;
    }
    h1,h2{ margin:8px 0 6px; text-align:center; color:#0b66ff; }
    p.helper{ color:#333; text-align:center; margin:4px 0 12px; }
    .brand{
      width:260px; max-width: 80vw; border-radius:10px; display:block; margin:10px auto 4px;
      border:1px solid #e5e7eb; box-shadow: 0 6px 14px rgba(0,0,0,.06);
    }
    label{ display:block; font-weight:800; color:#0b66ff; margin:10px 0 6px; }
    input,button{
      width:100%; padding:12px; font-size:16px; box-sizing:border-box;
      border-radius:10px; border:2px solid #cbd5e1; background:#fff;
    }
    input:focus{ outline:none; border-color:#0b66ff; }
    .btn-primary{ background:#0b66ff; color:#fff; border-color:#0a58d3; font-weight:800; }
    button:hover{ filter: brightness(.96); }
    .btn-row{ display:flex; gap:12px; }
    .btn-row>*{ flex:1; }
    @media (max-width:560px){ .btn-row{ flex-direction:column; } }

    /* Leyenda/aviso arriba del tablero */
    .legend{
      display:flex; gap:10px; justify-content:center; align-items:center;
      flex-wrap:wrap; margin:8px 0 8px;
    }
    .tag{ font-weight:800; font-size:.85rem; padding:6px 10px; border-radius:999px; border:2px solid; }
    .tag-available{ background:#0b66ff; color:#fff; border-color:#0a58d3; }
    .tag-selected{ background:#e9f8ef; color:#16a34a; border-color:#16a34a; }
    .tag-unavailable{ background:#eef2f7; color:#6b7280; border-color:#cbd5e1; }

    /* Tablero */
    .num-grid{
      display:grid; gap:10px; margin:10px 0 4px;
      grid-template-columns: repeat(5, minmax(0,1fr));
    }
    @media (min-width:900px){
      .num-grid{ grid-template-columns: repeat(10, minmax(0,1fr)); }
    }
    .num-btn{
      display:flex; align-items:center; justify-content:center;
      height:46px; border-radius:12px; cursor:pointer;
      background:#0b66ff; color:#fff; font-weight:900; font-variant-numeric: tabular-nums;
      border:2px solid #0a58d3; user-select:none; letter-spacing:.5px;
      transition: transform .06s ease, box-shadow .12s ease, border-color .12s ease;
    }
    .num-btn:hover{ transform: translateY(-1px); box-shadow: 0 4px 10px rgba(11,102,255,.18); }
    .num-btn.selected{
      box-shadow: 0 0 0 3px rgba(22,163,74,.22);
      border-color:#16a34a;
    }
    .num-btn.unavailable{
      background:#eef2f7; color:#6b7280; border-color:#cbd5e1; cursor:not-allowed; box-shadow:none;
    }

    .muted{ color:#6b7280; font-size:.95rem; }
    .center{ text-align:center; } /* Restaurado para centrar los copys */
    .hidden{ display:none !important; }

    /* Loader */
    <style>
    .loader{ position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
      background:rgba(0,0,0,.35); z-index:9999; opacity:1; transition: opacity .12s ease; }
    .loader.hidden{ display:flex !important; opacity:0; pointer-events:none; }
    .spinner-ios{ position:relative; width:64px; height:64px; }
    .spinner-ios i{ position:absolute; left:50%; top:50%; width:6px; height:18px; margin:-9px 0 0 -3px;
      background:#fff; border-radius:3px; opacity:.2; animation:iosFade 1.2s linear infinite; transform-origin:center center; }
    @keyframes iosFade{ 0%,39%,100%{opacity:.2;} 40%{opacity:1;} }
    .spinner-ios i:nth-child(1){ transform:rotate(0deg) translateY(-24px); animation-delay:-1.1s; }
    .spinner-ios i:nth-child(2){ transform:rotate(30deg) translateY(-24px); animation-delay:-1.0s; }
    .spinner-ios i:nth-child(3){ transform:rotate(60deg) translateY(-24px); animation-delay:-0.9s; }
    .spinner-ios i:nth-child(4){ transform:rotate(90deg) translateY(-24px); animation-delay:-0.8s; }
    .spinner-ios i:nth-child(5){ transform:rotate(120deg) translateY(-24px); animation-delay:-0.7s; }
    .spinner-ios i:nth-child(6){ transform:rotate(150deg) translateY(-24px); animation-delay:-0.6s; } /* Arreglado */
    .spinner-ios i:nth-child(7){ transform:rotate(180deg) translateY(-24px); animation-delay:-0.5s; } /* Arreglado */
    .spinner-ios i:nth-child(8){ transform:rotate(210deg) translateY(-24px); animation-delay:-0.4s; } /* Arreglado */
    .spinner-ios i:nth-child(9){ transform:rotate(240deg) translateY(-24px); animation-delay:-0.3s; } /* Arreglado */
    .spinner-ios i:nth-child(10){ transform:rotate(270deg) translateY(-24px); animation-delay:-0.2s; } /* Arreglado */
    .spinner-ios i:nth-child(11){ transform:rotate(300deg) translateY(-24px); animation-delay:-0.1s; } /* Arreglado */
    .spinner-ios i:nth-child(12){ transform:rotate(330deg) translateY(-24px); animation-delay:0s; }  /* Arreglado */
  </style>
</head>
<body>
  <!-- Loader -->
  <div id="loader" class="loader hidden" aria-live="polite" aria-busy="true">
    <div class="spinner-ios" role="status" aria-label="Cargando">
      <i></i><i></i><i></i><i></i><i></i><i></i>
      <i></i><i></i><i></i><i></i><i></i><i></i>
    </div>
  </div>

  <div class="container">
    <!-- VISTA 1 -->
    <section id="view-inicio" class="view active">
      <div class="card">
        <h1>Gran Rifa</h1>
        <p class="helper"><b>¡Gracias por tu colaboración!</b><br>Lee atentamente la información en la imagen.</p>
        <img class="brand" alt="Rifa" src="https://res.cloudinary.com/dqqeavica/image/upload/v1760479571/rifa_ziz9vg.gif" />
        <div class="btn-row" style="max-width:420px;margin:10px auto 0;">
          <button id="btn-empezar" class="btn-primary">Empezar Ahora</button>
        </div>
        <p class="center muted" style="margin:10px 0 0;">
          Copyright © <a href="https://wa.me/573103230712" target="_blank" rel="noopener"><b>Oscar Polanía</b></a>
        </p>
      </div>
    </section>

    <!-- VISTA 2 -->
    <section id="view-seleccion" class="view">
      <div class="card">
        <h2>Selecciona tus Números</h2>
        <p class="helper">Selecciona tus números y completa el registro para confirmar.</p>

        <!-- AVISO/LEYENDA ARRIBA DEL TABLERO -->
        <div class="legend" id="legend">
          <span class="tag tag-available">Disponible</span>
          <span class="tag tag-selected">Seleccionado</span>
          <span class="tag tag-unavailable">No disponible</span>
        </div>

        <!-- TABLERO -->
        <div id="num-grid" class="num-grid" aria-live="polite"></div>

        <!-- FORM -->
        <label for="nombre">Tu Nombre</label>
        <input id="nombre" type="text" placeholder="Escribe tu Nombre" aria-describedby="help-nombre" />
        <small id="help-nombre" class="muted">Escribe tu Nombre</small>

        <label for="telefono" style="margin-top:10px;">Teléfono</label>
        <input id="telefono" inputmode="numeric" type="tel" placeholder="10 dígitos" aria-describedby="help-telefono" />
        <small id="help-telefono" class="muted">Escribe tu Número de contacto</small>

        <div class="btn-row" style="margin-top:12px;">
          <button id="btn-guardar" class="btn-primary">Guardar</button>
          <button id="btn-volver">Atrás</button>
        </div>
        <p class="center muted" style="margin:10px 0 0;">
          Copyright © <a href="https://wa.me/573103230712" target="_blank" rel="noopener"><b>Oscar Polanía</b></a>
        </p>
      </div>
    </section>
  </div>

  <script>
    // URL de tu Web App
    const API_BASE = 'https://script.google.com/macros/s/AKfycbzeQyWjuf4ubyaV7Suwef4biG6TfcNWkKlEfoUAHie1WrDgBsGaGtiwBKHqfA_Fe4Ii/exec';

    // Sonidos
    const SOUNDS = {
      info: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011578/Default_notification_pkp4wr.mp3',
      success: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011577/Pay_success_t5aawh.mp3',
      warning: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011578/Low_battery_d5qua1.mp3',
      error: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011578/Low_battery_d5qua1.mp3',
      resumen: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011577/Charging_clkgcd.mp3',
      back: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011578/Keyboard_Enter_b9k2dc.mp3'
    };
    function playSoundOnce(url){ try{ new Audio(url).play().catch(()=>{}); }catch(_){} }
    if (window.Swal && typeof Swal.fire === 'function'){
      const __fire = Swal.fire.bind(Swal);
      Swal.fire = function(options = {}, ...rest){
        try{
          if (options.soundTag === 'resumen') playSoundOnce(SOUNDS.resumen);
          else if (options.icon && SOUNDS[options.icon]) playSoundOnce(SOUNDS[options.icon]);
        }catch(_){}
        return __fire(options, ...rest);
      }
    }

    // Loader
    const loader = document.getElementById('loader'); let loading=0, t=null;
    function startLoading(){ if(++loading===1){ t=setTimeout(()=>{ loader.classList.remove('hidden'); t=null; },120);} }
    function stopLoading(){ if(loading>0 && --loading===0){ if(t){clearTimeout(t); t=null;} loader.classList.add('hidden'); } }

    // API helpers
    async function apiGet(action, params = {}){
      startLoading();
      try{
        const url = new URL(API_BASE); url.search = new URLSearchParams({action, ...params}).toString();
        const r = await fetch(url.toString()); const j = await r.json();
        if(!j.ok) throw new Error(j.error || 'Error'); return j.data;
      } finally { stopLoading(); }
    }
    async function apiPost(action, body = {}){
      startLoading();
      try{
        const r = await fetch(API_BASE + '?action=' + encodeURIComponent(action), {
          method:'POST', headers:{'Content-Type':'text/plain;charset=utf-8'}, body: JSON.stringify(body)
        });
        const j = await r.json(); if(!j.ok) throw new Error(j.error || 'Error'); return j.data;
      } finally { stopLoading(); }
    }

    // Estado
    let DATA = [];                 // [{emoji, estado}]
    const selected = new Set();    // guarda EMOJIS seleccionados (para escribir igual que en hoja)

    // Util: emoji "0️⃣1️⃣" -> "01"
    function emojiToLabel(emoji){
      try{
        const digits = (emoji.match(/\d/g) || []).join('');
        if (digits.length === 2) return digits;
        if (digits.length === 1) return digits.padStart(2, '0');
      }catch(_){}
      // Fallback: muestra el emoji tal cual
      return emoji || '';
    }

    function showView(id){
      for(const v of document.querySelectorAll('.view')) v.classList.remove('active');
      document.getElementById(id).classList.add('active');
      window.scrollTo({ top: 0, behavior:'smooth' });
    }

    function renderNumeros(items){
      const grid = document.getElementById('num-grid');
      grid.innerHTML = '';
      selected.clear();

      for(const it of items){
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'num-btn';
        btn.dataset.emoji = it.emoji;
        btn.textContent = emojiToLabel(it.emoji);

        const disponible = String(it.estado||'').trim().toUpperCase() === 'DISPONIBLE';
        if(!disponible){
          btn.classList.add('unavailable');
          btn.disabled = true;
        }

        btn.addEventListener('click', ()=>{
          if(btn.classList.contains('selected')){
            btn.classList.remove('selected');
            selected.delete(btn.dataset.emoji);
          }else{
            btn.classList.add('selected');
            selected.add(btn.dataset.emoji);
          }
        });

        grid.appendChild(btn);
      }
    }

    async function cargarNumeros(){
      DATA = await apiGet('getnumeros');
      renderNumeros(Array.isArray(DATA) ? DATA : []);
    }

    function validar(){
      // Normaliza nombre a MAYÚSCULAS y teléfono a solo dígitos antes de enviar
      let nombre = (document.getElementById('nombre').value || '');
      nombre = nombre.normalize('NFC').replace(/\s+/g,' ').trim().toLocaleUpperCase('es-CO');

      let telefono = (document.getElementById('telefono').value || '');
      telefono = telefono.replace(/\D/g,'').trim(); // solo dígitos

      if (selected.size < 1) { Swal.fire({icon:'warning', title:'Selecciona al menos un número'}); return null; }
      if (!nombre) { Swal.fire({icon:'warning', title:'Nombre requerido'}); return null; }
      if (!/^\d{10}$/.test(telefono)) { Swal.fire({icon:'warning', title:'Teléfono inválido', text:'Debe tener exactamente 10 dígitos.'}); return null; }
      return { nombre, telefono, numeros: [...selected] };
    }

    // Eventos
    document.getElementById('btn-empezar').addEventListener('click', async ()=>{
      try{ await cargarNumeros(); showView('view-seleccion'); }
      catch(e){ Swal.fire({icon:'error', title:'No se pudieron cargar los números', text:e.message}); }
    });
    document.getElementById('btn-volver').addEventListener('click', ()=>{ playSoundOnce(SOUNDS.back); showView('view-inicio'); });

    document.getElementById('btn-guardar').addEventListener('click', async ()=>{
      const body = validar(); if(!body) return;

      const resumenHtml = `
        <b>Números:</b> ${body.numeros.map(emojiToLabel).join(', ')}<br>
        <b>Nombre:</b> ${body.nombre}<br>
        <b>Teléfono:</b> ${body.telefono}
      `;
      const rs = await Swal.fire({
        icon:'info', title:'Confirma tu selección', html:resumenHtml,
        showCancelButton:true, confirmButtonText:'Confirmar', cancelButtonText:'Editar',
        soundTag:'resumen'
      });
      if(!rs.isConfirmed) return;

      try{
        await apiPost('reservar', body);

        const resp = await Swal.fire({
          icon:'success',
          title:'Apuesta Realizada',
          text:'Por favor confirma en cualquiera de las dos opciones',
          showDenyButton:true,
          confirmButtonText:'Oscar',
          denyButtonText:'Mafe',
          allowOutsideClick:false,
          allowEscapeKey:false
        });

        const openWA = (phone, msg) => {
          const url = `https://api.whatsapp.com/send?phone=${encodeURIComponent(phone)}&text=${encodeURIComponent(msg)}`;
          window.open(url, '_blank');
        };
        if(resp.isConfirmed) openWA('573103230712','¡Listo Oscar!, ya seleccioné mis números.');
        if(resp.isDenied)    openWA('573183851642','¡Listo Mafe!, ya seleccioné mis números.');

        // Reset y volver
        document.getElementById('nombre').value = '';
        document.getElementById('telefono').value = '';
        selected.clear();
        showView('view-inicio');
      }catch(e){
        Swal.fire({icon:'error', title:'No se pudo guardar', text:e.message});
      }
    });
  </script>
</body>
</html>
