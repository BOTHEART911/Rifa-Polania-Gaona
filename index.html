<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Gran Rifa</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    :root{
      --primary:#007BFF;
      --primary-2:#0056b3;
      --ok:#16a34a;
      --error:#dc2626;
      --scrim:rgba(0,0,0,.35);
    }
    html,body{
      margin:0; padding:0; height:100%; width:100%;
      overflow-x:hidden;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:#111;
      background: #f6f8ff;
    }
    .container{ max-width: 960px; margin: 0 auto; padding: 16px; }

    /* Vistas con transición */
    .view{ display:none; opacity:0; transform: translateY(8px);
      transition: opacity .25s ease, transform .25s ease;
      box-sizing:border-box; padding:0 16px;
    }
    .view.active{ display:block; opacity:1; transform: translateY(0); }

    /* Tarjetas y elementos básicos */
    .card{
      background: rgba(255,255,255,.9);
      backdrop-filter: blur(3px);
      border: 2px solid #ddd; border-radius: 12px;
      box-shadow: 0 8px 18px rgba(0,0,0,.08);
      max-width: 640px; margin: 16px auto; padding: 16px;
    }
    h1,h2{ margin: 8px 0 12px; text-align:center; }
    p.helper{ color:#333; font-size:1rem; text-align:center; margin:8px 0 16px; }
    label{ display:block; font-weight:700; margin: 10px 0 6px; color:var(--primary); }
    input, button, textarea{
      width:100%; padding:12px; box-sizing:border-box;
      border:1.5px solid #ccc; border-radius:8px; background:#fff;
      outline:none; transition: border-color .2s ease, transform .08s ease;
      font-size:16px;
    }
    input:focus, textarea:focus{ border-color:var(--primary); }
    button{
      cursor:pointer; border:2px solid var(--primary);
      background:#fff; color:#000; font-weight:800;
    }
    button:hover{ background:var(--primary-2); color:#fff; border-color:var(--primary-2); }
    .btn-primary{ background:var(--primary); color:#fff; }
    .btn-row{ display:flex; gap:12px; }
    .btn-row > *{ flex:1; }
    .center{ text-align:center; }
    .muted{ color:#666; font-size:.95rem; }

    .brand{
      width:260px; max-width: 80vw; border-radius:10px; display:block; margin:12px auto;
      border: 1px solid #ddd;
      box-shadow: 0 6px 14px rgba(0,0,0,.08);
    }

    /* Loader centrado (overlay) */
    .loader{
      position:fixed; inset:0;
      display:flex; align-items:center; justify-content:center;
      background:rgba(0,0,0,.35);
      z-index:9999; backdrop-filter: blur(2px);
      opacity:1; transition: opacity .12s ease;
    }
    .loader.hidden{
      display:flex !important;
      opacity:0; pointer-events:none;
    }
    .spinner-ios{
      position:relative; width:64px; height:64px;
    }
    .spinner-ios i{
      position:absolute; left:50%; top:50%;
      width:6px; height:18px; margin:-9px 0 0 -3px;
      background:#fff; border-radius:3px;
      opacity:.2;
      animation:iosFade 1.2s linear infinite;
      transform-origin: center center;
    }
    @keyframes iosFade{
      0%, 39%, 100% { opacity:.2; }
      40% { opacity:1; }
    }
    .spinner-ios i:nth-child(1)  { transform: rotate(  0deg) translateY(-24px); animation-delay:-1.1s; }
    .spinner-ios i:nth-child(2)  { transform: rotate( 30deg) translateY(-24px); animation-delay:-1.0s; }
    .spinner-ios i:nth-child(3)  { transform: rotate( 60deg) translateY(-24px); animation-delay:-0.9s; }
    .spinner-ios i:nth-child(4)  { transform: rotate( 90deg) translateY(-24px); animation-delay:-0.8s; }
    .spinner-ios i:nth-child(5)  { transform: rotate(120deg) translateY(-24px); animation-delay:-0.7s; }
    .spinner-ios i:nth-child(6)  { transform: rotate(150deg) translateY(-24px); animation-delay:-0.6s; }
    .spinner-ios i:nth-child(7)  { transform: rotate(180deg) translateY(-24px); animation-delay:-0.5s; }
    .spinner-ios i:nth-child(8)  { transform: rotate(210deg) translateY(-24px); animation-delay:-0.4s; }
    .spinner-ios i:nth-child(9)  { transform: rotate(240deg) translateY(-24px); animation-delay:-0.3s; }
    .spinner-ios i:nth-child(10) { transform: rotate(270deg) translateY(-24px); animation-delay:-0.2s; }
    .spinner-ios i:nth-child(11) { transform: rotate(300deg) translateY(-24px); animation-delay:-0.1s; }
    .spinner-ios i:nth-child(12) { transform: rotate(330deg) translateY(-24px); animation-delay: 0s; }

    .hidden{ display:none !important; }
    .spaced{ margin-top:12px; }

    /* Grid de números (emojis) */
    .num-grid{
      display:grid;
      gap:10px;
      grid-template-columns: repeat(5, minmax(0, 1fr)); /* móvil: 5 columnas */
      margin: 12px 0;
    }
    @media (min-width: 900px){
      .num-grid{ grid-template-columns: repeat(10, minmax(0, 1fr)); } /* desktop: 10 columnas */
    }

    .num-btn{
      display:flex; align-items:center; justify-content:center;
      font-size: 22px; line-height: 1; padding: 10px 8px;
      border:2px solid #ccc; border-radius:12px; background:#fff;
      user-select:none;
      transition: border-color .15s ease, box-shadow .15s ease, transform .06s ease;
      height: 52px;
    }
    .num-btn:hover{ border-color: var(--primary); }
    .num-btn.selected{
      border-color: var(--ok);
      box-shadow: 0 0 0 3px rgba(22,163,74,.18);
    }
    .num-btn.unavailable{
      opacity:.45; cursor:not-allowed;
      background:#f3f3f3;
    }

    /* Botones responsivos */
    @media (max-width: 560px){
      .btn-row{ flex-direction:column; }
    }
  </style>
</head>
<body>
  <!-- Loader -->
  <div id="loader" class="loader hidden" aria-live="polite" aria-busy="true">
    <div class="spinner-ios" role="status" aria-label="Cargando">
      <i></i><i></i><i></i><i></i><i></i><i></i>
      <i></i><i></i><i></i><i></i><i></i><i></i>
    </div>
  </div>

  <div class="container">
    <!-- VISTA 1: INICIO -->
    <section id="view-inicio" class="view active">
      <div class="card">
        <h1 style="color:var(--primary); text-shadow: 0 2px 2px #031732;">Gran Rifa</h1>
        <p class="helper">
          <b>¡Gracias por tu colaboración!</b><br>
          Lee atentamente la información en la imagen.
        </p>
        <img class="brand" alt="Rifa" src="https://res.cloudinary.com/dqqeavica/image/upload/v1759798601/noticias_dax8sd.jpg" />
        <div class="btn-row spaced" style="max-width:420px; margin:0 auto;">
          <button id="btn-empezar" class="btn-primary">Empezar Ahora</button>
        </div>
      </div>
    </section>

    <!-- VISTA 2: SELECCIÓN -->
    <section id="view-seleccion" class="view">
      <div class="card">
        <h2 style="color:var(--primary)">Selecciona tus Números</h2>
        <p class="helper">Selecciona tus números y completa el registro para confirmar.</p>

        <div id="num-grid" class="num-grid" aria-live="polite"></div>

        <div class="spaced">
          <label for="nombre">Tu Nombre</label>
          <input id="nombre" type="text" placeholder="Escribe tu Nombre" aria-describedby="help-nombre" />
          <small id="help-nombre" class="muted">Escribe tu Nombre</small>
        </div>

        <div class="spaced">
          <label for="telefono">Teléfono</label>
          <input id="telefono" inputmode="numeric" type="tel" placeholder="10 dígitos" aria-describedby="help-telefono" />
          <small id="help-telefono" class="muted">Escribe tu Número de contacto</small>
        </div>

        <div class="btn-row spaced">
          <button id="btn-guardar" class="btn-primary">Guardar</button>
          <button id="btn-volver">Atrás</button>
        </div>
      </div>
    </section>
  </div>

  <script>
    // URL de tu Web App de Apps Script (reemplaza tras desplegar)
    // Ejemplo: const API_BASE = 'https://script.google.com/macros/s/AKfy.../exec';
    const API_BASE = 'https://script.google.com/macros/s/AKfycbzeQyWjuf4ubyaV7Suwef4biG6TfcNWkKlEfoUAHie1WrDgBsGaGtiwBKHqfA_Fe4Ii/exec';

    // Sonidos (extraídos)
    const SOUNDS = {
      question: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011577/Pay_fail_ls2aif.mp3',
      info: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011578/Default_notification_pkp4wr.mp3',
      success: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011577/Pay_success_t5aawh.mp3',
      error: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011578/Low_battery_d5qua1.mp3',
      warning: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011578/Low_battery_d5qua1.mp3',
      resumen: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011577/Charging_clkgcd.mp3',
      back: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011578/Keyboard_Enter_b9k2dc.mp3'
    };
    function playSoundOnce(url){
      try{ new Audio(url).play().catch(()=>{}); }catch(_){}
    }
    // Patch SweetAlert2 para sonar
    if (window.Swal && typeof Swal.fire === 'function'){
      const __fire = Swal.fire.bind(Swal);
      Swal.fire = function(options = {}, ...rest){
        try{
          if (options.soundTag === 'resumen'){
            playSoundOnce(SOUNDS.resumen);
          } else {
            const icon = options.icon || options.type;
            if (icon && SOUNDS[icon]) playSoundOnce(SOUNDS[icon]);
          }
        }catch(_){}
        return __fire(options, ...rest);
      }
    }

    // Loader
    const loader = document.getElementById('loader');
    let loadingCount = 0, loaderTimer = null;
    function startLoading(){
      loadingCount++;
      if (loadingCount === 1){
        loaderTimer = setTimeout(()=>{ loader.classList.remove('hidden'); loaderTimer=null; }, 120);
      }
    }
    function stopLoading(){
      if (loadingCount === 0) return;
      loadingCount--;
      if (loadingCount === 0){
        if (loaderTimer){ clearTimeout(loaderTimer); loaderTimer=null; }
        loader.classList.add('hidden');
      }
    }

    // Fetch helpers
    async function apiGet(action, params = {}){
      startLoading();
      try{
        const url = new URL(API_BASE);
        url.search = new URLSearchParams({ action, ...params }).toString();
        const r = await fetch(url.toString(), { method: 'GET' });
        const j = await r.json();
        if(!j.ok) throw new Error(j.error || 'Error');
        return j.data;
      } finally { stopLoading(); }
    }
    async function apiPost(action, body = {}){
      startLoading();
      try{
        const url = API_BASE + '?action=' + encodeURIComponent(action);
        const r = await fetch(url, {
          method:'POST',
          headers: { 'Content-Type':'text/plain;charset=utf-8' },
          body: JSON.stringify(body)
        });
        const j = await r.json();
        if(!j.ok) throw new Error(j.error || 'Error');
        return j.data;
      } finally { stopLoading(); }
    }

    // Estado
    let ALL_NUMS = []; // [{emoji, estado}]
    const selected = new Set();

    function showView(id){
      for(const el of document.querySelectorAll('.view')) el.classList.remove('active');
      document.getElementById(id).classList.add('active');
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function renderNumeros(items){
      const grid = document.getElementById('num-grid');
      grid.innerHTML = '';
      selected.clear();

      for(const it of items){
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'num-btn';
        btn.textContent = it.emoji || '';
        const disponible = String(it.estado || '').trim().toUpperCase() === 'DISPONIBLE';

        if(!disponible){
          btn.classList.add('unavailable');
          btn.disabled = true;
        }

        btn.addEventListener('click', ()=>{
          if(btn.classList.contains('selected')){
            btn.classList.remove('selected');
            selected.delete(it.emoji);
          }else{
            btn.classList.add('selected');
            selected.add(it.emoji);
          }
        });

        grid.appendChild(btn);
      }
    }

    async function cargarNumeros(){
      const data = await apiGet('getnumeros');
      ALL_NUMS = Array.isArray(data) ? data : [];
      renderNumeros(ALL_NUMS);
    }

    // Validaciones
    function validarFormulario(){
      const nombre = (document.getElementById('nombre').value || '').trim();
      const telefono = (document.getElementById('telefono').value || '').trim();

      if(selected.size < 1){
        Swal.fire({ icon:'warning', title:'Selecciona al menos un número' });
        return null;
      }
      if(!nombre){
        Swal.fire({ icon:'warning', title:'Nombre requerido', text:'Escribe tu Nombre' });
        return null;
      }
      if(!/^\d{10}$/.test(telefono)){
        Swal.fire({ icon:'warning', title:'Teléfono inválido', text:'Debe tener exactamente 10 dígitos.' });
        return null;
      }
      return { nombre, telefono, numeros: [...selected] };
    }

    // Eventos UI
    document.getElementById('btn-empezar').addEventListener('click', async ()=>{
      try{
        await cargarNumeros();
        showView('view-seleccion');
      }catch(e){
        Swal.fire({ icon:'error', title:'Error', text:e.message || 'No se pudieron cargar los números.' });
      }
    });

    document.getElementById('btn-volver').addEventListener('click', ()=>{
      playSoundOnce(SOUNDS.back);
      showView('view-inicio');
    });

    document.getElementById('btn-guardar').addEventListener('click', async ()=>{
      const payload = validarFormulario();
      if(!payload) return;

      // Resumen
      const resumenHtml = `
        <b>Números:</b> ${payload.numeros.join(', ')}<br>
        <b>Nombre:</b> ${payload.nombre}<br>
        <b>Teléfono:</b> ${payload.telefono}
      `;
      const rs = await Swal.fire({
        icon:'info',
        title:'Confirma tu selección',
        html:resumenHtml,
        showCancelButton:true,
        confirmButtonText:'Confirmar',
        cancelButtonText:'Editar',
        soundTag:'resumen'
      });
      if(!rs.isConfirmed) return;

      try{
        await apiPost('reservar', payload);

        // Post-confirmación: WhatsApp a Oscar o Mafe
        const info = await Swal.fire({
          icon:'success',
          title:'Apuesta Realizada',
          text:'Por favor confirma en cualquiera de las dos opciones',
          showDenyButton:true,
          confirmButtonText:'Oscar',
          denyButtonText:'Mafe',
          allowOutsideClick:false,
          allowEscapeKey:false
        });

        const msgOscar = '¡Listo Oscar!, ya seleccioné mis números.';
        const msgMafe  = '¡Listo Mafe!, ya seleccioné mis números.';
        const openWA = (phone, msg) => {
          const url = `https://api.whatsapp.com/send?phone=${encodeURIComponent(phone)}&text=${encodeURIComponent(msg)}`;
          window.open(url, '_blank');
        };

        if(info.isConfirmed){
          openWA('573103230712', msgOscar);
        }else if(info.isDenied){
          openWA('573183851642', msgMafe);
        }

        // Reset y volver al inicio
        document.getElementById('nombre').value = '';
        document.getElementById('telefono').value = '';
        selected.clear();
        showView('view-inicio');
      }catch(e){
        Swal.fire({ icon:'error', title:'No se pudo guardar', html: (e.message || 'Intento fallido') });
      }
    });
  </script>
</body>
</html>
